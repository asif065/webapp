name: K8s API reachability test (IP)

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Show runner public IP
        run: |
          echo "Runner public IP:"
          curl -s https://api.ipify.org
          echo

      - name: TCP connectivity (port reachable?)
        env:
          KUBE_IP: ${{ secrets.KUBE_IP }}
          KUBE_PORT: ${{ secrets.KUBE_PORT }}
        run: |
          echo "Testing TCP to $KUBE_IP:$KUBE_PORT"
          timeout 5 bash -lc "cat < /dev/null > /dev/tcp/$KUBE_IP/$KUBE_PORT" \
            && echo "✅ TCP connect OK" \
            || (echo "❌ TCP connect FAILED (firewall/router blocking)" && exit 1)

      - name: Curl /livez (reachability over HTTPS)
        env:
          KUBE_IP: ${{ secrets.KUBE_IP }}
          KUBE_PORT: ${{ secrets.KUBE_PORT }}
        run: |
          URL="https://$KUBE_IP:$KUBE_PORT/livez"
          echo "Curling $URL"
          curl -k -sS -D - "$URL" -o /dev/null | head -n 40

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Configure kubeconfig and test kubectl (auth + RBAC)
        env:
          KUBE_SERVER: ${{ secrets.KUBE_SERVER }} # e.g. https://103.217.109.62:16443
          KUBE_CA: ${{ secrets.KUBE_CA }}         # base64 CA data
          KUBE_TOKEN: ${{ secrets.KUBE_TOKEN }}   # serviceaccount token
        run: |
          set -euo pipefail

          # Write CA cert to a file (works across kubectl versions)
          echo "$KUBE_CA" | base64 -d > ca.crt

          kubectl config set-cluster target \
            --server="$KUBE_SERVER" \
            --certificate-authority=ca.crt

          kubectl config set-credentials gha \
            --token="$KUBE_TOKEN"

          kubectl config set-context test \
            --cluster=target \
            --user=gha

          kubectl config use-context test

          echo "kubectl version:"
          kubectl version --short

          echo "Listing namespaces:"
          kubectl get ns
